#!/bin/bash

# Function to check if a command was successful
check_success() {
    if [ $? -ne 0 ]; then
        echo "Error: $1 failed."
        exit 1
    fi
}

# Update package list and install SDDM and ImageMagick
echo "Installing SDDM and ImageMagick..."
sudo xbps-install -Sy sddm imagemagick
check_success "SDDM and ImageMagick installation"

# Enable SDDM with runit
echo "Enabling SDDM with runit..."
if [ ! -L /var/service/sddm ]; then
    sudo ln -s /etc/sv/sddm /var/service/
    check_success "Enabling SDDM service with runit"
else
    echo "SDDM is already enabled."
fi

# Set up SDDM custom theme directory
SDDM_THEME_DIR="/usr/share/sddm/themes/stickman-theme"
sudo mkdir -p "$SDDM_THEME_DIR"
check_success "Creating theme directory"

# SDDM Theme Configuration
echo "Setting up the SDDM theme..."
cat <<EOL | sudo tee "$SDDM_THEME_DIR/theme.conf"
[General]
background=$SDDM_THEME_DIR/background.png
type=QML

[Greeter]
position=center
EOL
check_success "Creating theme.conf file"

# Create the QML file for SDDM layout
echo "Creating QML layout file..."
cat <<EOL | sudo tee "$SDDM_THEME_DIR/Main.qml"
import QtQuick 2.0
import QtQuick.Controls 2.0

Item {
    id: root

    Rectangle {
        id: backgroundRect
        anchors.fill: parent
        gradient: Gradient {
            GradientStop { position: 0.0; color: "yellow" }
            GradientStop { position: 1.0; color: "purple" }
        }
    }

    // Login form on the left
    Column {
        anchors.centerIn: parent
        spacing: 20

        Text {
            text: "Username:"
            font.pixelSize: 24
            color: "white"
        }

        TextField {
            id: usernameField
            width: 300
            font.pixelSize: 24
        }

        Text {
            text: "Password:"
            font.pixelSize: 24
            color: "white"
        }

        TextField {
            id: passwordField
            width: 300
            echoMode: TextInput.Password
            font.pixelSize: 24
        }

        Button {
            text: "Login"
            onClicked: {
                // Trigger the login function
                login()
            }
        }
    }

    // "Stickman-OS" text centered
    Text {
        id: stickmanText
        text: "Stickman-OS"
        anchors.centerIn: parent
        font.pixelSize: 72
        color: "mediumgrey"
    }
}
EOL
check_success "Creating Main.qml file for theme layout"

# Create the background image with gradient and centered text for SDDM
echo "Generating background image for SDDM..."
convert -size 1920x1080 gradient:yellow-purple -pointsize 120 \
    -gravity center -fill mediumgrey -annotate +0+0 'Stickman-OS' "$SDDM_THEME_DIR/background.png"
check_success "Generating background image"

# Configure SDDM to use the custom theme by modifying /etc/sddm.conf
SDDM_CONF="/etc/sddm.conf"
if [ ! -f "$SDDM_CONF" ]; then
    echo "[Theme]" | sudo tee -a "$SDDM_CONF"
fi

# Set theme and confirm it was applied
echo "Configuring SDDM to use the new theme..."
sudo sed -i '/^\[Theme\]/,/^Current/ {s/^Current=.*/Current=stickman-theme/}' "$SDDM_CONF"
grep -q "Current=stickman-theme" "$SDDM_CONF"
check_success "Setting theme in sddm.conf"

# Restart SDDM and check if it's running
echo "Restarting SDDM to apply changes..."
sudo sv restart sddm
check_success "Restarting SDDM"

# Check if SDDM service is active
sleep 2  # Allow a moment for SDDM to start
if sudo sv status sddm | grep -q "run"; then
    echo "SDDM setup with custom theme complete and is running successfully."
else
    echo "Error: SDDM service failed to start."
    exit 1
fi
